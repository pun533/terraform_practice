name: Terraform Deploy

on:
  push:
    branches:
      - main   # ya jis branch pe tum deploy karna chahte ho
  
jobs:
  terraform:
    name: 'Terraform'
    runs-on: Chomu

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Update apt and install dependencies
      run: sudo apt-get update -y

    - name: HashiCorp - Setup Terraform
      # You may pin to the exact commit or the version.
      # uses: hashicorp/setup-terraform@633666f66e0061ca3b725c73b2ec20cd13a8fdd1
      uses: hashicorp/setup-terraform@v2.0.3
      with:
        # The hostname of a Terraform Cloud/Enterprise instance to place within the credentials block of the Terraform CLI configuration file. Defaults to `app.terraform.io`.
        cli_config_credentials_hostname: app.terraform.io        
        # The version of Terraform CLI to install. Instead of full version string you can also specify constraint string starting with "<" (for example `<1.13.0`) to install the latest version satisfying the constraint. A value of `latest` will install the latest version of Terraform CLI. Defaults to `latest`.
        terraform_version: latest
        # Whether or not to install a wrapper to wrap subsequent calls of the `terraform` binary and expose its STDOUT, STDERR, and exit code as outputs named `stdout`, `stderr`, and `exitcode` respectively. Defaults to `true`.
        terraform_wrapper: true
          

    # - name: Install Terraform
    #   run: sudo apt-get install -y terraform    

    # - name: Setup Terraform
    #   uses: hashicorp/setup-terraform@v3
    #   with:
    #     terraform_version: 1.6.6  # apni version ke according update karo
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Terraform Init
      run: terraform init

    - name: Terraform Validate
      run: terraform validate

    - name: Terraform Plan
      run: terraform plan

    # ðŸ‘‡ Apply ko optional rakho ya approval ke saath use karo
    - name: Terraform Apply
      run: terraform apply -auto-approve
